name: xUnit Tests (Reusable)

on:
  workflow_call:
    inputs:
      runner_os:
        description: 'Runner OS for xUnit tests'
        type: string
        required: false
        default: ubuntu-latest
      test_results_artifact_name:
        description: 'Artifact name for xUnit test results directory'
        type: string
        required: false
        default: testResults-xunit

jobs:
  xunit:
    name: Run xUnit Tests
    runs-on: ${{ inputs.runner_os }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          global-json-file: ./global.json

      - name: Bootstrap
        shell: pwsh
        run: |
          Import-Module ./tools/ci.psm1
          Invoke-CIInstall -SkipUser

      - name: Build PowerShell
        shell: pwsh
        run: |
          Import-Module ./tools/ci.psm1
          $releaseTag = Get-ReleaseTag
          Start-PSBuild -PSModuleRestore -Configuration 'Release' -CI -ReleaseTag $releaseTag

      - name: Run full xUnit test suite
        shell: pwsh
        run: |
          Import-Module ./tools/ci.psm1
          Write-Host "Running full xUnit test suite (no skipping)..."
          Invoke-CIxUnit
          Write-Host "Completed xUnit test run."

      - name: Upload xUnit results
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.test_results_artifact_name }}
          path: ${{ github.workspace }}/xunit
