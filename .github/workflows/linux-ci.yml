name: Linux-CI

run-name: "${{ github.ref_name }} - ${{ github.run_number }}"

on:
  workflow_dispatch:

  push:
    branches:
      - master
      - release/**
      - github-mirror
    paths:
      - "**"
      - "!.github/ISSUE_TEMPLATE/**"
      - "!.dependabot/config.yml"
      - "!.pipelines/**"
      - "!test/perf/**"
  pull_request:
    branches:
      - master
      - release/**
      - github-mirror
# Path filters for PRs need to go into the changes job

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ contains(github.ref, 'merge')}}

env:
  DOTNET_CLI_TELEMETRY_OPTOUT: 1
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: 1
  FORCE_FEATURE: 'False'
  FORCE_PACKAGE: 'False'
  NUGET_KEY: none
  POWERSHELL_TELEMETRY_OPTOUT: 1
  __SuppressAnsiEscapeSequences: 1
  nugetMultiFeedWarnLevel: none
  system_debug: 'false'
jobs:
  changes:
    if: startsWith(github.repository_owner, 'azure') || github.repository_owner == 'PowerShell'
    name: Change Detection
    runs-on: ubuntu-latest
    # Required permissions
    permissions:
      pull-requests: read
      contents: read

    # Set job outputs to values from filter step
    outputs:
      source: ${{ steps.filter.outputs.source }}
    steps:
      - name: checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: Check if GitHubWorkflowChanges is present
        id: filter
        uses: actions/github-script@v7.0.1
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            // Fetch the list of files changed in the PR
            let files = [];
            let page = 1;
            let fetchedFiles;
            do {
              fetchedFiles = await github.rest.pulls.listFiles({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.issue.number,
                per_page: 100,
                page: page++
              });
              files = files.concat(fetchedFiles.data);
            } while (fetchedFiles.data.length > 0);

            const actionsChanged = files.some(file => file.filename.startsWith('.github/actions'));
            const workflowsChanged = files.some(file => file.filename.startsWith('.github/workflows'));
            const githubChanged = actionsChanged || workflowsChanged;

            const toolsCiPsm1Changed = files.some(file => file.filename.startsWith('tools/ci.psm1'));
            const toolsBuildCommonChanged = files.some(file => file.filename.startsWith('tools/buildCommon/'));
            const toolsChanged = toolsCiPsm1Changed || toolsBuildCommonChanged;

            const propsChanged = files.some(file => file.filename.endsWith('.props'));

            const testsChanged = files.some(file => file.filename.startsWith('test/powershell/') || file.filename.startsWith('test/tools/') || file.filename.startsWith('test/xUnit/'));

            const mainSourceChanged = files.some(file => file.filename.startsWith('src/'));

            const buildModuleChanged = files.some(file => file.filename.startsWith('build.psm1'));

            const source = mainSourceChanged || toolsChanged || githubChanged || propsChanged || testsChanged;

            core.setOutput('toolsChanged', toolsChanged);
            core.setOutput('githubChanged', githubChanged);
            core.setOutput('propsChanged', propsChanged);
            core.setOutput('testsChanged', testsChanged);
            core.setOutput('mainSourceChanged', mainSourceChanged);
            core.setOutput('buildModuleChanged', buildModuleChanged);
            core.setOutput('source', source);

      - name: Capture outputs
        run: |
          Write-Verbose -Verbose "source: ${{ steps.filter.outputs.source }}"
          Write-Verbose -Verbose "github: ${{ steps.filter.outputs.githubChanged }}"
          Write-Verbose -Verbose "tools: ${{ steps.filter.outputs.toolsChanged }}"
          Write-Verbose -Verbose "props: ${{ steps.filter.outputs.propsChanged }}"
          Write-Verbose -Verbose "tests: ${{ steps.filter.outputs.testsChanged }}"
          Write-Verbose -Verbose "mainSource: ${{ steps.filter.outputs.mainSourceChanged }}"
          Write-Verbose -Verbose "buildModule: ${{ steps.filter.outputs.buildModuleChanged }}"
        shell: pwsh

  ci_build:
    name: Build PowerShell
    runs-on: ubuntu-latest
    needs: changes
    if: ${{ startsWith(github.repository_owner, 'azure') || needs.changes.outputs.source == 'true' }}
    steps:
      - name: checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1000

      - name: Build
        uses: "./.github/actions/build/ci"
  linux_test_unelevated_ci:
    name: Linux Unelevated CI
    needs:
      - ci_build
      - changes
    if: ${{ startsWith(github.repository_owner, 'azure') || needs.changes.outputs.source == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - name: checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1000
      - name: Linux Unelevated CI
        uses: "./.github/actions/test/nix"
        with:
          purpose: UnelevatedPesterTests
          tagSet: CI
  linux_test_elevated_ci:
    name: Linux Elevated CI
    needs:
      - ci_build
      - changes
    if: ${{ startsWith(github.repository_owner, 'azure') || needs.changes.outputs.source == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - name: checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1000
      - name: Linux Elevated CI
        uses: "./.github/actions/test/nix"
        with:
          purpose: ElevatedPesterTests
          tagSet: CI
  linux_test_unelevated_others:
    name: Linux Unelevated Others
    needs:
      - ci_build
      - changes
    if: ${{ startsWith(github.repository_owner, 'azure') || needs.changes.outputs.source == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - name: checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1000
      - name: Linux Unelevated Others
        uses: "./.github/actions/test/nix"
        with:
          purpose: UnelevatedPesterTests
          tagSet: Others
  linux_test_elevated_others:
    name: Linux Elevated Others
    needs:
      - ci_build
      - changes
    if: ${{ startsWith(github.repository_owner, 'azure') || needs.changes.outputs.source == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - name: checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1000
      - name: Linux Elevated Others
        uses: "./.github/actions/test/nix"
        with:
          purpose: ElevatedPesterTests
          tagSet: Others
  verify_xunit:
    name: Verify xUnit test results
    needs:
      - ci_build
      - changes
    if: ${{ startsWith(github.repository_owner, 'azure') || needs.changes.outputs.source == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - name: checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1000
      - name: Verify xUnit test results
        uses: "./.github/actions/test/verify_xunit"

  analyze:
    permissions:
      actions: read  # for github/codeql-action/init to get workflow details
      contents: read  # for actions/checkout to fetch code
      security-events: write  # for github/codeql-action/analyze to upload SARIF results
    name: Analyze
    runs-on: ubuntu-latest
    needs: changes
    if: ${{ startsWith(github.repository_owner, 'azure') || needs.changes.outputs.source == 'true' }}

    strategy:
      fail-fast: false
      matrix:
        # Override automatic language detection by changing the below list
        # Supported options are ['csharp', 'cpp', 'go', 'java', 'javascript', 'python']
        language: ['csharp']
        # Learn more...
        # https://docs.github.com/en/github/finding-security-vulnerabilities-and-errors-in-your-code/configuring-code-scanning#overriding-automatic-language-detection

    steps:
    - name: Checkout repository
      uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      with:
        fetch-depth: '0'

    - uses: actions/setup-dotnet@v4
      with:
        global-json-file: ./global.json

    # Initializes the CodeQL tools for scanning.
    - name: Initialize CodeQL
      uses: github/codeql-action/init@1b549b9259bda1cb5ddde3b41741a82a2d15a841 # v3.28.13
      with:
        languages: ${{ matrix.language }}
        # If you wish to specify custom queries, you can do so here or in a config file.
        # By default, queries listed here will override any specified in a config file.
        # Prefix the list here with "+" to use these queries and those in the config file.
        # queries: ./path/to/local/query, your-org/your-repo/queries@main

    - run: |
        Get-ChildItem -Path env: | Out-String -width 9999 -Stream | write-Verbose -Verbose
      name: Capture Environment
      shell: pwsh

    - run: |
        Import-Module .\tools\ci.psm1
        Invoke-CIInstall -SkipUser
      name: Bootstrap
      shell: pwsh

    - run: |
        Import-Module .\tools\ci.psm1
        Invoke-CIBuild
      name: Build
      shell: pwsh

    - name: Perform CodeQL Analysis
      uses: github/codeql-action/analyze@1b549b9259bda1cb5ddde3b41741a82a2d15a841 # v3.28.13

  ready_to_merge:
    name: Linux ready to merge
    needs:
      - verify_xunit
      - linux_test_elevated_ci
      - linux_test_elevated_others
      - linux_test_unelevated_ci
      - linux_test_unelevated_others
      - analyze
    if: always()
    uses: PowerShell/compliance/.github/workflows/ready-to-merge.yml@v1.0.0
    with:
      needs_context: ${{ toJson(needs) }}
  # TODO: Enable this when we have a Linux packaging workflow

  # ERROR:  While executing gem ... (Gem::FilePermissionError)
  # You don't have write permissions for the /var/lib/gems/2.7.0 directory.
  #   WARNING: Installation of gem dotenv 2.8.1 failed! Must resolve manually.

  # linux_packaging:
  #   name: Attempt Linux Packaging
  #   needs: ci_build
  #   runs-on: ubuntu-20.04
  #   steps:
  #     - name: checkout
  #       uses: actions/checkout@v4
  #       with:
  #         fetch-depth: 1000
  #     - name: Verify xUnit test results
  #       uses: "./.github/actions/test/linux-packaging"
