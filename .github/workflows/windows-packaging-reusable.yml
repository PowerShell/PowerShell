name: Windows Packaging (Reusable)

on:
  workflow_call:

env:
  GIT_CONFIG_PARAMETERS: "'core.autocrlf=false'"
  DOTNET_CLI_TELEMETRY_OPTOUT: 1
  POWERSHELL_TELEMETRY_OPTOUT: 1
  DOTNET_NOLOGO: 1
  __SuppressAnsiEscapeSequences: 1
  nugetMultiFeedWarnLevel: none
  SYSTEM_ARTIFACTSDIRECTORY: ${{ github.workspace }}/artifacts
  BUILD_ARTIFACTSTAGINGDIRECTORY: ${{ github.workspace }}/artifacts

jobs:
  package:
    name: ${{ matrix.architecture }} - ${{ matrix.channel }}
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - architecture: x64
            channel: preview
            runtimePrefix: win7
          - architecture: x64
            channel: stable
            runtimePrefix: win7
            runASA: true
          - architecture: x86
            channel: stable
            runtimePrefix: win7
          - architecture: x86
            channel: preview
            runtimePrefix: win7
          - architecture: arm64
            channel: preview
            runtimePrefix: win

    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 1000

      - name: Capture Environment
        if: success() || failure()
        run: |
          Import-Module .\tools\ci.psm1
          Show-Environment
        shell: pwsh

      - name: Capture PowerShell Version Table
        if: success() || failure()
        run: |
          $PSVersionTable
        shell: pwsh

      - name: Switch to Public Feeds
        if: success()
        run: |
          Import-Module .\tools\ci.psm1
          Switch-PSNugetConfig -Source Public
        shell: pwsh

      - name: Setup .NET
        uses: actions/setup-dotnet@v5
        with:
          global-json-file: ./global.json

      - name: Bootstrap
        if: success()
        run: |
          Import-Module .\tools\ci.psm1
          Invoke-CIInstall -SkipUser
        shell: pwsh

      - name: Build and Package
        run: |
          Import-Module .\tools\ci.psm1
          New-CodeCoverageAndTestPackage
          Invoke-CIFinish -Runtime ${{ matrix.runtimePrefix }}-${{ matrix.architecture }} -channel ${{ matrix.channel }}
        shell: pwsh

      - name: Run Attack Surface Analyzer in Container
        if: matrix.runASA == true
        run: |
          Write-Host "Running Attack Surface Analyzer in clean Windows container..."

          # Find the MSI file that was built
          $msiPath = Get-ChildItem -Path "$env:SYSTEM_ARTIFACTSDIRECTORY" -Filter "*.msi" -Recurse | Select-Object -First 1 -ExpandProperty FullName
          if (-not $msiPath) {
            throw "Could not find MSI file in artifacts directory"
          }
          Write-Host "Found MSI: $msiPath"

          # Create a directory for container volume mount
          $containerWorkDir = "$env:TEMP\asa-container-work"
          New-Item -ItemType Directory -Force -Path $containerWorkDir | Out-Null

          # Copy MSI to container work directory
          $msiFileName = Split-Path $msiPath -Leaf
          Copy-Item $msiPath -Destination "$containerWorkDir\$msiFileName"

          # Create PowerShell script to run inside container
          $scriptLines = @(
            '# Install .NET tool (ASA)',
            'Write-Host "Installing Attack Surface Analyzer in container..."',
            'dotnet tool install -g Microsoft.CST.AttackSurfaceAnalyzer.CLI --version 2.3.328',
            '$env:PATH += ";$env:USERPROFILE\.dotnet\tools"',
            '',
            '# Take baseline snapshot',
            'Write-Host "Taking baseline snapshot..."',
            '& "$env:USERPROFILE\.dotnet\tools\asa.exe" collect -f -s -r -u -p -l --directories "C:\Program Files\PowerShell,C:\Program Files (x86)\PowerShell"',
            '',
            '# Install the MSI',
            'Write-Host "Installing PowerShell MSI..."',
            '$msiFile = Get-ChildItem -Path C:\work -Filter *.msi | Select-Object -First 1 -ExpandProperty FullName',
            'Start-Process msiexec.exe -ArgumentList "/i", $msiFile, "/quiet", "/norestart", "/l*v", "C:\work\install.log" -Wait -NoNewWindow',
            '',
            '# Take post-installation snapshot',
            'Write-Host "Taking post-installation snapshot..."',
            '& "$env:USERPROFILE\.dotnet\tools\asa.exe" collect -f -s -r -u -p -l --directories "C:\Program Files\PowerShell,C:\Program Files (x86)\PowerShell"',
            '',
            '# Export results',
            'Write-Host "Exporting comparison results..."',
            '& "$env:USERPROFILE\.dotnet\tools\asa.exe" export-collect --outputsarif --savetodatabase',
            '',
            '# Copy results to work directory',
            'Write-Host "Copying results to work directory..."',
            'Copy-Item -Path "*.txt" -Destination C:\work\ -ErrorAction SilentlyContinue',
            'Copy-Item -Path "*.sarif" -Destination C:\work\ -ErrorAction SilentlyContinue',
            'Copy-Item -Path "asa.sqlite" -Destination C:\work\ -ErrorAction SilentlyContinue',
            '',
            'Write-Host "Attack Surface Analyzer test completed in container."'
          )

          $scriptLines | Set-Content -Path "$containerWorkDir\run-asa.ps1"

          # Run container with volume mount
          Write-Host "Starting Windows container..."
          docker run --rm `
            --isolation process `
            -v "${containerWorkDir}:C:\work" `
            mcr.microsoft.com/dotnet/sdk:9.0-windowsservercore-ltsc2022 `
            powershell -ExecutionPolicy Bypass -File C:\work\run-asa.ps1

          # Copy results back to workspace
          Write-Host "Copying results from container work directory to workspace..."
          Copy-Item -Path "$containerWorkDir\*_summary.json.txt" -Destination $env:GITHUB_WORKSPACE -ErrorAction SilentlyContinue
          Copy-Item -Path "$containerWorkDir\*_results.json.txt" -Destination $env:GITHUB_WORKSPACE -ErrorAction SilentlyContinue
          Copy-Item -Path "$containerWorkDir\*.sarif" -Destination $env:GITHUB_WORKSPACE -ErrorAction SilentlyContinue
          Copy-Item -Path "$containerWorkDir\asa.sqlite" -Destination $env:GITHUB_WORKSPACE -ErrorAction SilentlyContinue
          Copy-Item -Path "$containerWorkDir\install.log" -Destination $env:GITHUB_WORKSPACE -ErrorAction SilentlyContinue

          Write-Host "Attack Surface Analyzer container test completed successfully."
        shell: pwsh

      - name: Upload Attack Surface Analyzer Results
        if: matrix.runASA == true && always()
        uses: actions/upload-artifact@v4
        with:
          name: attack-surface-analyzer-results-${{ matrix.architecture }}-${{ matrix.channel }}
          path: |
            ${{ github.workspace }}/*_summary.json.txt
            ${{ github.workspace }}/*_results.json.txt
            ${{ github.workspace }}/*.sarif
            ${{ github.workspace }}/asa.sqlite

      - name: Upload Build Artifacts
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: windows-packaging-${{ matrix.architecture }}-${{ matrix.channel }}
          path: |
            ${{ github.workspace }}/artifacts/**/*
            !${{ github.workspace }}/artifacts/**/*.pdb

