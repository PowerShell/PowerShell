name: CI Build
description: 'Builds PowerShell'
runs:
  using: composite
  steps:
  - name: Install PowerShell
    run: |-
      [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.SecurityProtocolType]::Tls12
      $pwsh = Get-Command pwsh -ErrorAction SilentlyContinue -CommandType Application
      if ($null -eq $pwsh) {
        $powerShellPath = Join-Path -Path $env:AGENT_TEMPDIRECTORY -ChildPath 'powershell'
        Invoke-WebRequest -Uri https://raw.githubusercontent.com/PowerShell/PowerShell/master/tools/install-powershell.ps1 -outfile ./install-powershell.ps1
        ./install-powershell.ps1 -Destination $powerShellPath
        $vstsCommandString = "vso[task.setvariable variable=PATH]$powerShellPath;$env:PATH"
        Write-Host "sending " + $vstsCommandString
        Write-Host "##$vstsCommandString"
      }
    shell: powershell
  - name: Capture Environment
    if: success() || failure()
    run: 'Get-ChildItem -Path env: | Out-String -width 9999 -Stream | write-Verbose -Verbose'
    shell: pwsh
  - name: Set Build Name for Non-PR
    if: github.event_name != 'PullRequest'
    run: Write-Host "##vso[build.updatebuildnumber]$env:BUILD_SOURCEBRANCHNAME-$env:BUILD_SOURCEVERSION-$((get-date).ToString("yyyyMMddhhmmss"))"
    shell: pwsh
  - uses: "./.github/actions/tools_releasebuild_azuredevops_templates_insert_nuget_config_azfeed"
    if: env.UseAzDevOpsFeed != ''
  - name: Bootstrap
    if: success()
    run: |-
      Write-Verbose -Verbose "Running Bootstrap..."
      Import-Module .\tools\ci.psm1
      Invoke-CIInstall -SkipUser
      Write-Verbose -Verbose "Start Sync-PSTags"
      Sync-PSTags -AddRemoteIfMissing
      Write-Verbose -Verbose "End Sync-PSTags"
    shell: pwsh
  - name: Build
    if: success()
    run: |-
      Write-Verbose -Verbose "Running Build..."
      Import-Module .\tools\ci.psm1
      Invoke-CIBuild
    shell: pwsh
  - name: xUnit Tests
    if: success()
    continue-on-error: true
    run: |-
      Write-Verbose -Verbose "Running xUnit tests..."
      Import-Module .\tools\ci.psm1
      Restore-PSOptions
      Invoke-CIxUnit -SkipFailing
    shell: pwsh
  - name: Upload build artifact
    uses: actions/upload-artifact@v4
    with:
      name: build
      path: ${{ runner.workspace }}/build
  - name: Upload xunit artifact
    uses: actions/upload-artifact@v4
    with:
      name: xunit
      path: ${{ runner.workspace }}/xunit
