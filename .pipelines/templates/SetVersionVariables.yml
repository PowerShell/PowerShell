parameters:
- name: ReleaseTagVar
  default: v6.2.0
- name: ReleaseTagVarName
  default: ReleaseTagVar
- name: CreateJson
  default: 'no'
- name: ob_restore_phase
  type: boolean
  default: true

steps:
- template: set-reporoot.yml@self
  parameters:
    ob_restore_phase: ${{ parameters.ob_restore_phase }}

- powershell: |
    $createJson = ("${{ parameters.CreateJson }}" -ne "no")

    $REPOROOT = $env:REPOROOT

    if (-not (Test-Path $REPOROOT/tools/releaseBuild/setReleaseTag.ps1)) {
      if (Test-Path "$REPOROOT/PowerShell/tools/releaseBuild/setReleaseTag.ps1") {
        $REPOROOT = "$REPOROOT/PowerShell"
      } else {
        throw "Could not find setReleaseTag.ps1 in $REPOROOT/tools/releaseBuild or $REPOROOT/PowerShell/tools/releaseBuild"
      }
    }

    $releaseTag = & "$REPOROOT/tools/releaseBuild/setReleaseTag.ps1" -ReleaseTag ${{ parameters.ReleaseTagVar }} -Variable "${{ parameters.ReleaseTagVarName }}" -CreateJson:$createJson
    $version = $releaseTag.Substring(1)
    $vstsCommandString = "vso[task.setvariable variable=Version]$version"
    Write-Host ("sending " + $vstsCommandString)
    Write-Host "##$vstsCommandString"
    $azureVersion = $releaseTag.ToLowerInvariant() -replace '\.', '-'
    $vstsCommandString = "vso[task.setvariable variable=AzureVersion]$azureVersion"
    Write-Host ("sending " + $vstsCommandString)
    Write-Host "##$vstsCommandString"
  displayName: 'Set ${{ parameters.ReleaseTagVarName }} and other version Variables'
  env:
    ob_restore_phase: ${{ parameters.ob_restore_phase }}

- powershell: |
    Get-ChildItem -Path Env: | Out-String -Width 150
  displayName: Capture environment
  condition: succeededOrFailed()
  env:
    ob_restore_phase: ${{ parameters.ob_restore_phase }}
