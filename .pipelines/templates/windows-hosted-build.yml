# This Yaml Document has been converted by ESAI Yaml Pipeline Conversion Tool.
# Please make sure to check all the converted content, it is your team's responsibility to make sure that the pipeline is still valid and functions as expected.
# parameters:
# - name: BuildConfiguration
#   default: release
# - name: BuildPlatform
#   default: any cpu
# - name: Architecture
#   default: x64
# - name: parentJob
#   default: ''
steps:
- checkout: self
  clean: true
  env:
    ob_restore_phase: true # This ensures checkout is done at the beginning of the restore phase

- template: /.pipelines/templates/SetVersionVariables.yml@self
  parameters:
    ReleaseTagVar: $(ReleaseTagVar)

- template: /.pipelines/templates/cloneToOfficialPath.yml@self

- template: /.pipelines/templates/insert-nuget-config-azfeed.yml@self
  parameters:
    repoRoot: $(PowerShellRoot)

- pwsh: |
    $runtime = switch ($env:Architecture)
      {
        "x64" { "win7-x64" }
        "x86" { "win7-x86" }
        "arm64" { "win-arm64" }
        "fxdependent" { "fxdependent" }
        "fxdependentWinDesktop" { "fxdependent-win-desktop" }
      }
    $params = @{}
    if ($env:BuildConfiguration -eq 'minSize') {
      $params['ForMinimalSize'] = $true
    }

    ##$(PowerShellRoot)/tools/releaseBuild/Images/microsoft_powershell_windowsservercore/PowerShellPackage.ps1 -location '$(PowerShellRoot)' -destination '$(Build.ArtifactStagingDirectory)/Symbols_$(Architecture)' -Runtime $runtime -ReleaseTag '$(ReleaseTagVar)' -Symbols @params

    Write-Verbose -Message "Building PowerShell with Runtime: $runtime for '$env:BuildConfiguration' configuration"
    Import-Module -Name $(PowerShellRoot)/build.psm1 -Force
    $null = New-Item -ItemType Directory -Path $(Build.ArtifactStagingDirectory)/Symbols_$(Architecture) -Force
    Start-PSBootstrap -Package
    $outputBuildPath = Join-Path -Path $(ob_outputDirectory) -ChildPath "Symbols_$(Architecture)"
    $null = New-Item -ItemType Directory -Path $outputBuildPath -Force -Verbose
    Start-PSBuild -Runtime $runtime -Configuration Release -Output $outputBuildPath @params
    Write-Verbose -Verbose "Completed building PowerShell for '$env:BuildConfiguration' configuration"
  displayName: 'Build Windows Universal - $(Architecture)-$(BuildConfiguration) Symbols zip'
  env:
    __DOTNET_RUNTIME_FEED_KEY: $(RUNTIME_SOURCEFEED_KEY)

### Call signing here

- pwsh: |
    $packageName = (Get-ChildItem '$(Build.ArtifactStagingDirectory)\Symbols_$(Architecture)').FullName
    $vstsCommandString = "vso[artifact.upload containerfolder=results;artifactname=results]$packageName"
    Write-Host ("sending " + $vstsCommandString)
    Write-Host "##$vstsCommandString"

    $packagePath = $env:ob_outputDirectory + "/results"
    $null = New-Item -ItemType Directory -Path $packagePath -Force
    Copy-Item -Path $packageName -Destination $packagePath -Force -Verbose

  displayName: Upload symbols package
- template: /.pipelines/templates/step/finalize.yml@self
